<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<dom-module id="json-schema-form">
	<script>
		(function () {
			'use strict';
			var templateInstance = null;
			var onElementFactoryChanged = function () {
				onSchemaChanged.call(this);
			};
			var onSchemaChanged = function () {
				if (this.elementFactory && this.schema) {
					var root = Polymer.dom(this.root);
					while (root.firstChild) {
						root.removeChild(root.firstChild);
					}
					var template = document.createElement('template');
					var element = this.elementFactory[this.schema.type]('elementFactory', 'schema', 'value');
					Polymer.dom(template.content).appendChild(element);
					this.templatize(template);
					var templateInstance = this.stamp({});
					templateInstance.elementFactory = this.elementFactory;
					templateInstance.schema = this.schema;
					templateInstance.value = this.value;
					Polymer.dom(this.root).appendChild(templateInstance.root);
					onValueChanged.call(this);
				}
			};
			var onValueChanged = function () {
				if (templateInstance) {
					templateInstance.value = this.value;
				}
			};
			Polymer({
				is: 'json-schema-form',
				behaviors: [
					Polymer.Templatizer
				],
				_forwardParentProp: function (prop, value) {

				},
				_forwardParentPath: function (path, value) {

				},
				_forwardInstanceProp: function (inst, prop, value) {

				},
				_forwardInstancePath: function (inst, path, value) {
					//var propertyNames = path.split();
					//var lastPropertyName = propertyNames.splice(propertyNames.length - 1, 1);
					//var parent = propertyNames.reduce(function (parent, propertyName) {
					//    return parent[propertyName];
					//}, this);
					this.set(path, value);
				},
				_instanceProps: {
					elementFactory: true,
					schema: true,
					value: true
				},
				properties: {
					elementFactory: {
						type: Object,
						value: {
							object: function (elementFactoryPath, schemaPath, valuePath) {
								var element = document.createElement('json-schema-object');
								Polymer.dom(element).setAttribute('element-factory', '{{' + elementFactoryPath + '}}');
								Polymer.dom(element).setAttribute('schema', '{{' + schemaPath + '}}');
								Polymer.dom(element).setAttribute('value', '{{' + valuePath + '}}');
								return element;
							},
							array: function (schema, value, elementFactory) {

							},
							string: function (elementFactoryPath, schemaPath, valuePath) {
								var element = document.createElement('paper-input');
								Polymer.dom(element).setAttribute('label', '{{' + schemaPath + '.title}}');
								Polymer.dom(element).setAttribute('value', '{{' + valuePath + '}}');
								return element;
							},
						},
						notify: false,
						readOnly: false,
						observer: '_elementFactoryChanged'
					}, schema: {
						type: Object,
						value: null,
						notify: false,
						readOnly: false,
						observer: '_schemaChanged'
					}, value: {
						type: Object,
						notify: true,
						readOnly: false,
						reflect: true,
						observer: '_valueChanged',
						value: { firstname: 'Florent', lastname: 'Tollin de Rivarol', address: {} }
					}
				},
				_elementFactoryChanged: function (newElementFactory, oldElementFactory) {
					if (newElementFactory != oldElementFactory) onElementFactoryChanged.call(this)
				},
				_schemaChanged: function (newSchema, oldSchema) {
					if (newSchema != oldSchema) onSchemaChanged.call(this);
				},
				_valueChanged: function (newValue, oldValue) {
					if (newValue != oldValue) onValueChanged.call(this);
				},
			});
		})();
	</script>
</dom-module>

<dom-module id="json-schema-object">
	<template>
		<paper-button id="create" raised hidden$="{{ value }}">Add {{ schema.title }}</paper-button>
		<div class="object" hidden$="{{ !value }}">
			<paper-button raised id="delete">Delete {{ schema.title }}</paper-button>
			<div id="object"></div>
		</div>
	</template>
	<script>
		(function () {
			'use strict';
			var onElementFactoryChanged = function () {
				onSchemaChanged.call(this);
			};
			var onSchemaChanged = function () {
				var objectElement = this.$.object;
				this._map = {};
				if (this.elementFactory && this.schema) {
					if (this.schema.properties) {
						var keys = Object.keys(this.schema.properties);
						var that = this;

						keys.forEach(function (key, index) {
							var template = document.createElement('template');
							var property = that.schema.properties[key];
							var element = that.elementFactory[property.type]('elementFactory', 'schema', 'value');
							Polymer.dom(template.content).appendChild(element);
							that.templatize(template);
							var templateInstance = that.stamp({});
							templateInstance.elementFactory= that.elementFactory;
							templateInstance.schema = that.schema.properties[key];
							templateInstance.value= that.value && that.value[key];
							templateInstance.path= key;
							that._map[key] = templateInstance;
							Polymer.dom(objectElement).appendChild(templateInstance.root);
						});
					}
					onValueChanged.call(this);
				}
			};
			var onValueChanged = function () {
				if (this.value && this.value instanceof Object) {
					var keys = Object.keys(this.schema.properties);
					var that = this;
					keys.forEach(function (key) {
						if (that._map[key]) that._map[key].value = that.value[key];
					});
				}
			};
			Polymer({
				is: 'json-schema-object',
				_hasNoValue: function (value) {
					var result = !(value instanceof Object && value);
					return result;
				},
				behaviors: [
					Polymer.Templatizer
				],
				_forwardParentProp: function (prop, value) {

				},
				_forwardParentPath: function (path, value) {

				},
				_prepParentProperties: function(archetype, template) {

				},
				_forwardInstanceProp: function (inst, prop, value) {
					if (this.value) {
						this.set('value.' + inst.path, value);
						//this.notifyPath(inst.path, value);
					}
				},
				_forwardInstancePath: function (inst, path, value) {
					//this.set('value.'+inst.path+'.'+path, value);
					path = path.split('.');
					var firstPart = path.splice(0, 1);
					if (firstPart == 'value') {
						var test = 'value.'+inst.path + '.' + path.join('.');
						this.notifyPath(test, value);
					}
				},
				_instanceProps: {
					elementFactory: true,
					schema: true,
					value: true
				},
				properties: {
					elementFactory: {
						type: Object,
						notify: false,
						readOnly: false,
						observer: '_elementFactoryChanged'
					}, schema: {
						type: Object,
						value: null,
						notify: false,
						readOnly: false,
						observer: '_schemaChanged'
					}, value: {
						type: Object,
						notify: true,
						readOnly: false,
						reflect: true,
						observer: '_valueChanged',
						value: null,
					}
				},
				_elementFactoryChanged: function (newElementFactory, oldElementFactory) {
					if (newElementFactory != oldElementFactory) onElementFactoryChanged.call(this)
				},
				_schemaChanged: function (newSchema, oldSchema) {
					if (newSchema != oldSchema) onSchemaChanged.call(this);
				},
				_valueChanged: function (newValue, oldValue) {
					if (newValue != oldValue) onValueChanged.call(this);
				},
				ready: function () {
					var that = this;
					this.$.create.addEventListener('click', function () {
						that.set('value', {});
					});
					this.$.delete.addEventListener('click', function () {
						that.set('value', null);
					});
				}
			});
		})();
	</script>
</dom-module>

<dom-module id="de-test">
	<script>
		(function () {
			'use strict';
			Polymer({
				is: 'de-test',
				behaviors: [
					Polymer.Templatizer
				],
				properties: {
					value: {
						type: String,
						value: 'qsdqsdqsdqsd',
						reflectToAttribute: true,
						notify: true
					}
				},
				_forwardParentProp: function (prop, value) {

				},
				_forwardParentPath: function (path, value) {

				},
				_forwardInstanceProp: function (inst, prop, value) {
					this.value = value;
					this.notifyPath('value', this.value);
				},
				_forwardInstancePath: function (inst, path, value) {

				},
				_instanceProps: {
					value: true
				},
				ready: function () {
					var template = document.createElement('template');
					var input = document.createElement('paper-input');
					var input2 = document.createElement('paper-input');
					input.setAttribute('value', '{{value}}');
					input2.setAttribute('value', '{{value}}');
					Polymer.dom(template.content).appendChild(input);
					Polymer.dom(template.content).appendChild(input2);
					this.templatize(template);
					var instance = this.stamp();
					Polymer.dom(this.root).appendChild(instance.root);
				}
			});
		})();
	</script>
</dom-module>

<dom-module id="darkengines-json">
	<template>
		<pre>{{json}}</pre>
	</template>

	<script>
		(function () {
			'use strict';
			Polymer({
				is: 'darkengines-json',
				properties: {
					value: Object,
					json: {
						type: String,
						computed: 'stringify(value, value.*)'
					}
				},
				stringify: function (value) {
					return JSON.stringify(value, null, '\t');
				}
			});
		})();
	</script>
</dom-module>

<dom-module id="darkengines-json-editor">
	<template>
		<paper-textarea multiple="true" label="[[label]]" value="{{value}}"></paper-textarea>
	</template>
	<style>
		paper-textarea {
			--paper-input-container-input: {
				line-height: initial;
				font-family: monospace;
				font-size: 12px;
			}
		}
	</style>
	<script>
		(function () {
			'use strict';
			Polymer({
				is: 'darkengines-json-editor',
				properties: {
					value: {
						type: String,
						readOnly: false,
						reflect: true,
						notify: true,
					},
					json: {
						type: Object,
						readOnly: false,
						reflect: true,
						notify: true,
					},
					label: {
						type: String
					}
				},
				observers: [
					'_valueChanged(value.*)',
					'_jsonChanged(json.*)'
				],
				_valueChanged: function (changeRecord) {
					var parsed = JSON.parse(changeRecord.value);
					var properties = [{
						parent: null,
						key: null
					}];
					var get = function (property, instance) {
						if (!property.parent) return instance;
						var parentValue = get(property.parent, instance);
						return parentValue && parentValue[property.key];
					};
					var set = function (property, instance, value) {
						if (!property.parent) this.json = value;
						var parent = get(property.parent, instance);
						if (parent) parent[property.key] = value;
					};
					while (properties.length) {
						debugger;
						var property = properties.pop();
						if (!get.call(this, property, this.json)) {
							set.call(this, property, this.json, get.call(this, property, parsed));
						} else {
							var value = (property.parent && property.parent[property.key]) || parsed;
							if (value instanceof Array) {
								value.forEach(function (item, index) {
									properties.push({
										parent: property,
										key: index
									});
								});
							} else if (value instanceof Object) {
								var keys = Object.keys(value);
								keys.forEach(function (key, index) {
									properties.push({
										parent: property,
										key: key
									});
								});
							} else {
								set.call(this, property, this.json, get.call(this, property, parsed));
							}
						}
					}
				},
				_jsonChanged: function (changeRecord) {
					this.value = JSON.stringify(changeRecord.value, null, '\t');
				}
			});
		})();
	</script>
</dom-module>