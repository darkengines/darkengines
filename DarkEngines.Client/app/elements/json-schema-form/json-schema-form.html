<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<dom-module id="json-schema-form">
	<template>{{value}}</template>

	<script>
		(function () {
			'use strict';
			var that = this;
			var root = null;
			var fillElement = function (element, schema, value, elementFactory) {
				element.schema = schema;
				element.elementFactory = elementFactory
				element.value = value;
			};
			var processElementFactory = function () {
				processSchema.call(this);
			}
			var processSchema = function () {
				if (this.elementFactory && this.schema) {
					while (this.firstChild) {
						this.removeChild(this.firstChild);
					}
					root = this.elementFactory[this.schema.type](this.schema, this.value, this.elementFactory);
					this.appendChild(root);
					processValue.call(this);
				}
			};
			var processValue = function () {
				if (root) {
					root.value = this.value;
				}
			};
			Polymer({
				is: 'json-schema-form',
				properties: {
					elementFactory: {
						type: Object,
						value: {
							object: function (schema, value, elementFactory) {
								var jsonSchemaObject = document.createElement('json-schema-object');
								fillElement(jsonSchemaObject, schema, value, elementFactory);
								return jsonSchemaObject;
							},
							array: function (schema, value, elementFactory) {
								var jsonSchemaArray = document.createElement('json-schema-array');
								fillElement(jsonSchemaArray, schema, value, elementFactory);
								return jsonSchemaArray;
							},
							string: function (schema, value, elementFactory) {
								var paperInput = document.createElement('paper-input');
								paperInput.value = value;
								paperInput.label = schema.title;
								return paperInput;
							},
						},
						notify: false,
						readOnly: false,
						observer: '_elementFactoryChanged'
					}, schema: {
						type: Object,
						value: null,
						notify: false,
						readOnly: false,
						observer: '_schemaChanged'
					}, value: {
						type: Object,
						value: null,
						notify: true,
						readOnly: false,
						reflect: true,
						observer: '_valueChanged'
					}
				},
				_elementFactoryChanged: function (newElementFactory, oldElementFactory) {
					if (newElementFactory != oldElementFactory) processElementFactory.call(this)
				},
				_schemaChanged: function (newSchema, oldSchema) {
					if (newSchema != oldSchema) processSchema.call(this);
				},
				_valueChanged: function (newValue, oldValue) {
					if (newValue != oldValue) processValue.call(this);
				},
			});
		})();
	</script>
</dom-module>

<dom-module id="json-schema-object">
	<template>
	</template>

	<script>
		(function () {
			'use strict';
			var children = {};
			var processElementFactory = function () {
				if (this.elementFactory) processSchema.call(this);
			}
			var processSchema = function () {
				if (this.elementFactory && this.schema) {
					var that = this;
					var keys = Object.keys(this.schema.properties);
					keys.forEach(function (key) {
						var property = that.schema.properties[key];
						var defaultValue = property.type == 'object' ? Object.assign({}, property.default)
							: property.type == 'array' ? Object.assign([], property.default)
							: property.default;
						var child = that.elementFactory[property.type](property, (that.value && that.value[key]) || defaultValue, that.elementFactory);
						children[key] = child;
						that.appendChild(child);
					});
				}
			};
			var processValue = function () {
				if (children) {
					var keys = Object.keys(this.schema.properties);
					var that = this;
					keys.forEach(function (key) {
						var property = that.schema.properties[key];
						children[key].value = that.value[key];
					});
				}
			};
			Polymer({
				is: 'json-schema-object',
				properties: {
					elementFactory: {
						type: Object,
						notify: false,
						readOnly: false,
						observer: '_elementFactoryChanged'
					}, schema: {
						type: Object,
						notify: false,
						readOnly: false,
						observer: '_schemaChanged'
					}, value: {
						value: null,
						notify: true,
						readOnly: false,
						reflect: true,
						observer: '_valueChanged'
					}
				},
				_elementFactoryChanged: function (newElementFactory, oldElementFactory) {
					if (newElementFactory != oldElementFactory) processElementFactory.call(this)
				},
				_schemaChanged: function (newSchema, oldSchema) {
					if (newSchema != oldSchema) processSchema.call(this);
				},
				_valueChanged: function (newValue, oldValue) {
					if (newValue != oldValue) processValue.call(this);
				},
			});
		})();
	</script>
</dom-module>

<dom-module id="json-schema-array">
	<template>
	</template>

	<script>
		(function () {
			'use strict';
			Polymer({
				is: 'json-schema-array',
				properties: {
					elementFactory: {
						type: Object,
						notify: false,
						readOnly: false
					}, schema: {
						type: Object,
						notify: true
					}, value: {
						value: null,
						notify: true,
					}
				},
				ready: function () {
					var that = this;
					var keys = Object.key(this.schema.properties);
					keys.forEach(function (key) {
						var property = that.schema.properties[key];
						var element = that.elementFactory[property.type](property, that.value[key], that.elementFactory);
						that.appendChild(element);
					});
				}
			});
		})();
	</script>
</dom-module>